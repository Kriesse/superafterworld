<!DOCTYPE html>
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <title>Super After World</title>

    <meta charset="utf-8">
    <!--=============================-->
    <!-- Copy this part to your app. -->
    <!-- START                       -->
    <!--=============================-->
    <!-- libs -->
    <!--[if IE]><script type="text/javascript" src="lib/excanvas.js"></script><![endif]-->
    <script src="lib/prototype-1.6.0.2.js"></script>

    <!-- socket.io -->
    <script src="/socket.io/socket.io.js"></script>

    <!-- box2djs -->
    <script src='js/box2d/common/b2Settings.js'></script>
    <script src='js/box2d/common/math/b2Vec2.js'></script>
    <script src='js/box2d/common/math/b2Mat22.js'></script>
    <script src='js/box2d/common/math/b2Math.js'></script>
    <script src='js/box2d/collision/b2AABB.js'></script>
    <script src='js/box2d/collision/b2Bound.js'></script>
    <script src='js/box2d/collision/b2BoundValues.js'></script>
    <script src='js/box2d/collision/b2Pair.js'></script>
    <script src='js/box2d/collision/b2PairCallback.js'></script>
    <script src='js/box2d/collision/b2BufferedPair.js'></script>
    <script src='js/box2d/collision/b2PairManager.js'></script>
    <script src='js/box2d/collision/b2BroadPhase.js'></script>
    <script src='js/box2d/collision/b2Collision.js'></script>
    <script src='js/box2d/collision/Features.js'></script>
    <script src='js/box2d/collision/b2ContactID.js'></script>
    <script src='js/box2d/collision/b2ContactPoint.js'></script>
    <script src='js/box2d/collision/b2Distance.js'></script>
    <script src='js/box2d/collision/b2Manifold.js'></script>
    <script src='js/box2d/collision/b2OBB.js'></script>
    <script src='js/box2d/collision/b2Proxy.js'></script>
    <script src='js/box2d/collision/ClipVertex.js'></script>
    <script src='js/box2d/collision/shapes/b2Shape.js'></script>
    <script src='js/box2d/collision/shapes/b2ShapeDef.js'></script>
    <script src='js/box2d/collision/shapes/b2BoxDef.js'></script>
    <script src='js/box2d/collision/shapes/b2CircleDef.js'></script>
    <script src='js/box2d/collision/shapes/b2CircleShape.js'></script>
    <script src='js/box2d/collision/shapes/b2MassData.js'></script>
    <script src='js/box2d/collision/shapes/b2PolyDef.js'></script>
    <script src='js/box2d/collision/shapes/b2PolyShape.js'></script>
    <script src='js/box2d/dynamics/b2Body.js'></script>
    <script src='js/box2d/dynamics/b2BodyDef.js'></script>
    <script src='js/box2d/dynamics/b2CollisionFilter.js'></script>
    <script src='js/box2d/dynamics/b2Island.js'></script>
    <script src='js/box2d/dynamics/b2TimeStep.js'></script>
    <script src='js/box2d/dynamics/contacts/b2ContactNode.js'></script>
    <script src='js/box2d/dynamics/contacts/b2Contact.js'></script>
    <script src='js/box2d/dynamics/contacts/b2ContactConstraint.js'></script>
    <script src='js/box2d/dynamics/contacts/b2ContactConstraintPoint.js'></script>
    <script src='js/box2d/dynamics/contacts/b2ContactRegister.js'></script>
    <script src='js/box2d/dynamics/contacts/b2ContactSolver.js'></script>
    <script src='js/box2d/dynamics/contacts/b2CircleContact.js'></script>
    <script src='js/box2d/dynamics/contacts/b2Conservative.js'></script>
    <script src='js/box2d/dynamics/contacts/b2NullContact.js'></script>
    <script src='js/box2d/dynamics/contacts/b2PolyAndCircleContact.js'></script>
    <script src='js/box2d/dynamics/contacts/b2PolyContact.js'></script>
    <script src='js/box2d/dynamics/b2ContactManager.js'></script>
    <script src='js/box2d/dynamics/b2World.js'></script>
    <script src='js/box2d/dynamics/b2WorldListener.js'></script>
    <script src='js/box2d/dynamics/joints/b2JointNode.js'></script>
    <script src='js/box2d/dynamics/joints/b2Joint.js'></script>
    <script src='js/box2d/dynamics/joints/b2JointDef.js'></script>
    <script src='js/box2d/dynamics/joints/b2DistanceJoint.js'></script>
    <script src='js/box2d/dynamics/joints/b2DistanceJointDef.js'></script>
    <script src='js/box2d/dynamics/joints/b2Jacobian.js'></script>
    <script src='js/box2d/dynamics/joints/b2GearJoint.js'></script>
    <script src='js/box2d/dynamics/joints/b2GearJointDef.js'></script>
    <script src='js/box2d/dynamics/joints/b2MouseJoint.js'></script>
    <script src='js/box2d/dynamics/joints/b2MouseJointDef.js'></script>
    <script src='js/box2d/dynamics/joints/b2PrismaticJoint.js'></script>
    <script src='js/box2d/dynamics/joints/b2PrismaticJointDef.js'></script>
    <script src='js/box2d/dynamics/joints/b2PulleyJoint.js'></script>
    <script src='js/box2d/dynamics/joints/b2PulleyJointDef.js'></script>
    <script src='js/box2d/dynamics/joints/b2RevoluteJoint.js'></script>
    <script src='js/box2d/dynamics/joints/b2RevoluteJointDef.js'></script>
    <!--=============================-->
    <!-- Copy this part to your app. -->
    <!-- END                         -->
    <!--=============================-->
    <script type="text/javascript" src="jquery-1.7.2.min.js"></script>

    <script type="text/javascript">
$(function() {

  function add_mario(data){
    var max = 25;
    var min = -25;
    // random max near center of screen
    var x = (width / 2) + (Math.random() * (max - min) + min);
    createMario(world, x, 0, mario_image.width, mario_image.height, data);
  };

  // set up socket.io
  // define add_mario before
  var socket = io.connect();
  socket.on('add_mario', add_mario);

  // set up canvas
  var height = $(window).height();
  var width = $(window).width();
  var canvas = document.getElementById('canvas');
  var ctx = canvas.getContext('2d');
  $(canvas).attr({
    height: height,
    width: width
  });

  // set up physics world
  var worldAABB = new b2AABB();
  worldAABB.minVertex.Set(0, 0);
  worldAABB.maxVertex.Set(width, height);
  var gravity = new b2Vec2(0, 300);
  var doSleep = true;
  var world = new b2World(worldAABB, gravity, doSleep);

  // animation speed + iteration (?)
  var timeStep = 1.0/60;
  var iteration = 1;

  // add ground
  var groundSd = new b2BoxDef();
  groundSd.extents.Set(width, 1);
  groundSd.restitution = 0;
  var groundBd = new b2BodyDef();
  groundBd.AddShape(groundSd);
  groundBd.position.Set(0, height);
  world.CreateBody(groundBd)

  // mario image
  var marioScale = 4;
  var marioHeight, marioWidth;
  var mario_image = new Image();
  mario_image.src = "graphics/mario/small/Standing-mario.gif";
  var mario_canvas;
  mario_image.onload = function() {
    mario_canvas = scaleImage(mario_image, marioScale);
    marioHeight = mario_image.height * marioScale;
    marioWidth = mario_image.width * marioScale;
  }

  // ghost images
  var ghost_image_left = new Image(), ghost_image_right = new Image();
  var ghost_scale = 5;
  var ghost_canvas_left, ghost_canvas_right, ghost_width, ghost_height;
  ghost_image_left.src = "graphics/enemies/Boo-chasing.left.gif";
  ghost_image_right.src = "graphics/enemies/Boo-chasing.right.gif";
  ghost_image_left.onload = function() {
    ghost_canvas_left = scaleImage(ghost_image_left, ghost_scale);
    ghost_height = ghost_image_left.height * ghost_scale;
    ghost_width = ghost_image_left.width * ghost_scale;
  }
  ghost_image_right.onload = function() {
    ghost_canvas_right = scaleImage(ghost_image_right, ghost_scale);
  }

  // ghost animations
  var ghost = {x: 300, x_left: 100, x_right: 500, y: 300, movement: 5};
  ghost.animate = function(ctx) {
    this.x = this.x + this.movement;
    if (this.x < this.x_left || this.x > this.x_right)
      this.movement = -this.movement;
    if (this.movement > 0) {
      if (ghost_canvas_right)
        ctx.drawImage(ghost_canvas_right, this.x, this.y);
    } else {
      if (ghost_canvas_left)
        ctx.drawImage(ghost_canvas_left, this.x, this.y);
    }
  };
  var ghost2 = $.extend({}, ghost, {x: 1600, x_left: 1500, x_right: 2200, y: 400, movement: -7});
  var ghost3 = $.extend({}, ghost, {x: 600, x_left: 500, x_right: 1200, y: 1000, movement: -3});



  // tower image
  var towerScale = 1.5;
  var towerHeight, towerWidth;
  var tower_image = new Image();
  tower_image.src = "graphics/afterlife/pink_TVtower.gif";
  var tower_canvas;
  tower_image.onload = function() {
    tower_canvas = scaleImage(tower_image, towerScale);
    towerHeight = tower_image.height * towerScale;
    towerWidth = tower_image.width * towerScale;
    // create here so we know we've loaded image
    createTower();
  }

  // bahn image
  var bahnScale = 1.25;
  var bahnHeight, bahnWidth;
  var bahn_image = new Image();
  bahn_image.src = "graphics/afterlife/ubahn.gif";
  var bahn_canvas;
  bahn_image.onload = function() {
    bahn_canvas = scaleImage(bahn_image, bahnScale);
    bahnHeight = bahn_image.height * bahnScale;
    bahnWidth = bahn_image.width * bahnScale;
    // create here so we know we've loaded image
    createBahn();
  }

  // returns an offscreen canvas with the marioScaled image on it
  function scaleImage(image, scale) {
    // Create an offscreen canvas, draw an image to it, and fetch the pixels
    var offcanvas = document.createElement('canvas');
    offcanvas.width = image.width * scale;
    offcanvas.height = image.height * scale;
    var offtx = offcanvas.getContext('2d');
    offtx.drawImage(image, 0, 0);
    var imgData = offtx.getImageData(0,0,image.width,image.height).data;
    offtx.clearRect(0, 0, image.width, image.height);
    // Draw the zoomed-up pixels to a different canvas context
    for (var x=0; x < image.width; ++x) {
      for (var y=0; y < image.height; ++y) {
        // Find the starting index in the one-dimensional image data
        var i = (y*image.width + x)*4;
        var r = imgData[i  ];
        var g = imgData[i+1];
        var b = imgData[i+2];
        var a = imgData[i+3];
        offtx.fillStyle = "rgba("+r+","+g+","+b+","+(a/255)+")";
        offtx.fillRect(x*scale,y*scale,scale,scale);
      }
    }
    return offcanvas;
  }

  function drawBoundingBox(shape, ctx) {
        ctx.strokeStyle = '#ff0000';
        ctx.beginPath();
      var tV = b2Math.AddVV(shape.m_position, b2Math.b2MulMV(shape.m_R, shape.m_vertices[0]));
      ctx.moveTo(tV.x, tV.y);
      for (var i = 0; i < shape.m_vertexCount; i++) {
        var v = b2Math.AddVV(shape.m_position, b2Math.b2MulMV(shape.m_R, shape.m_vertices[i]));
        ctx.lineTo(v.x, v.y);
      }
      ctx.lineTo(tV.x, tV.y);
      ctx.stroke()
 }

  // physics box thing which will represent dead mario position
  function createMario(world, x, y, width, height, data) {
    var boxSd = new b2BoxDef();
    // physics settings
    boxSd.density = 1.0;
    boxSd.restitution = 0;
    boxSd.friction = 0.5;
    boxSd.extents.Set(width, height);
    var boxBd = new b2BodyDef();
    boxBd.AddShape(boxSd);
    boxBd.position.Set(x,y);
    boxBd.userData = $.extend({player: "mario", type: "mario"}, data);
    world.CreateBody(boxBd);
  }

  function createTower() {
    var boxSd = new b2BoxDef();
    var pos = {
      x: width - towerWidth,
      y: height - towerHeight
    };
    boxSd.extents.Set(towerWidth / 2, towerHeight / 2);
    var boxBd = new b2BodyDef();
    boxBd.AddShape(boxSd);
    boxBd.position.Set(pos.x + towerWidth / 2, pos.y + towerHeight / 2);
    boxBd.userData = {
      type: 'tower'
    };
    world.CreateBody(boxBd);
  }

  function drawTower(ctx) {
    if (tower_canvas) {
      ctx.drawImage(tower_canvas, width - towerWidth,
          height - towerHeight);
    }
  }

  function createBahn() {
    var boxSd = new b2BoxDef();
    // physics settings
    // defaults to static body if comment out
    //boxSd.density = 1.0;
    //boxSd.restitution = 0;
    //boxSd.friction = 1;
    boxSd.extents.Set(bahnWidth, bahnHeight/2);
    var boxBd = new b2BodyDef();
    boxBd.AddShape(boxSd);
    boxBd.position.Set(0, height - (bahnHeight /2) );
    boxBd.userData = {
      type: 'bahn'
    };
    world.CreateBody(boxBd);
  }

  function drawBahn(ctx) {
    if (bahn_canvas) {
      ctx.drawImage(bahn_canvas, 0,
          height - bahnHeight);
    }
  }

  // iterate through all shapes of all bodies and draw them
  // also pass in the body to the drawShape function
  function drawWorld(world, ctx) {
    for (var b = world.m_bodyList; b; b = b.m_next) {
      for (var s = b.GetShapeList(); s != null; s = s.GetNext()) {
        drawShape(b, s, ctx);
      }
    }
  }

  // all drawing procedures go here
  // switch on userData.type
  function drawShape(body, shape, ctx) {
    var data = body.GetUserData() || {};
    switch (data.type) {
      case 'mario':
        if (mario_canvas) {
          var pos = shape.m_position;
          var rotation = body.GetRotation();
          var matrix = body.GetRotationMatrix();
          ctx.save();
          ctx.translate(pos.x, pos.y);
          ctx.rotate(rotation);
          ctx.font = '8px Emulogic ';
          ctx.fillStyle = "#FF69B4";
          ctx.textAlign = 'center';
          ctx.fillText(data.player, 0, -marioHeight/1.8);
          ctx.translate(-pos.x, -pos.y);
          ctx.drawImage(mario_canvas,
              // makes image match bounding box dunno
              Math.round(pos.x - marioWidth / 2),
              Math.round(pos.y - marioHeight / 2));
          ctx.restore();
          //drawBoundingBox(shape, ctx);
        }
      break;
      case 'tower':
          //drawBoundingBox(shape, ctx);
      break;
      case 'bahn':
          //drawBoundingBox(shape, ctx);
      break;
    }
  }

  function redraw() {
    world.Step(timeStep, iteration);
    ctx.clearRect(0, 0, width, height);
    drawWorld(world, ctx);
    drawTower(ctx);
    drawBahn(ctx);
    ghost.animate(ctx);
    ghost2.animate(ctx);
    ghost3.animate(ctx);
    window.requestAnimationFrame(redraw);
  };

  // on click marios
  $(window).click(function(e){
    createMario(world, e.pageX, e.pageY, mario_image.width * marioScale / 2, mario_image.height * marioScale / 2);
    });

  // start the whole thing
  window.requestAnimationFrame(redraw);

});
</script>

<style type="text/css">

@font-face {
    font-family: 'SuperPlumberBrothers';
    src: url('fonts/Super Plumber Brothers.ttf') format('truetype');
    font-weight: bold;
    font-style: normal;
}

@font-face {
    font-family: 'Emulogic';
    src: url('fonts/emulogic.ttf') format('truetype');
    font-weight: normal;
    font-style: normal;
}

body {
  image-rendering:-webkit-optimize-contrast;
}

html, body, .container {
  margin: 0;
  padding: 0;
  height: 100%;
  width: 100%;
}

body {
  letter-spacing: 4px;
  background-color: #0a0735;
  /* Webkit (Chrome 11+) */
  background-image:
    -webkit-radial-gradient(center top, ellipse farthest-corner, rgba(0,0,0,.1) 0%, rgba(0,0,0,1) 100%),
    url(graphics/backgrounds/nightsky_bg.gif);
  background-repeat: no-repeat, repeat;
}

.container {
  position: relative;
  top: 0;
}

.pipe {
  position: absolute;
  left: 50%;
  margin-left: -48px;
  height: 70px;
  width: 97px;
  background-image: url(graphics/afterlife/greentube.gif);
}

.foreground {
  background: url(graphics/backgrounds/nightsky_fg.gif) repeat-x;
  background-position: 0 0;
  opacity: 0.5;
  height: 432px;
  width: 100%;
  position: absolute;
  bottom: 0;
  -webkit-animation: smoke 50s linear infinite;
}

@-webkit-keyframes smoke {
  0% {
    background-position: 0px 0;
  }
  100% {
    background-position: 511px 0;
  }
}

canvas {
  width: 100%;
  height: 100%;
}

</style>
</head>
<body>
  <div class="container">
    <div class="pipe"></div>
    <div class="foreground"></div>
    <canvas id="canvas">
    </canvas>
  </div>
</body>
</html>

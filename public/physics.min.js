/**
 * Physics
 * A requirified port of Traer Physics from Processing to JavaScript.
 * Copyright (C) 2012 jonobr1
 * 
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 * 
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU General Public License for more details.
 * 
 * You should have received a copy of the GNU General Public License
 * along with this program. If not, see <http://www.gnu.org/licenses/>.
 */
(function(){var e=Array.prototype,u=Object.prototype,G=u.hasOwnProperty,H=e.slice,v=e.forEach,w=e.indexOf,x=u.toString,y=function(a,b,c){if(null!=a)if(v&&a.forEach===v)a.forEach(b,c);else if(a.length===+a.length)for(var d=0,i=a.length;d<i&&!(d in a&&b.call(c,a[d],d,a)===breaker);d++);else for(d in a)if(_.has(a,d)&&b.call(c,a[d],d,a)===breaker)break},z=function(a){return a},A=function(a,b,c){c||(c=z);for(var d=0,i=a.length;d<i;){var k=d+i>>1;c(a[k])<c(b)?d=k+1:i=k}return d};common={has:function(a,
b){return G.call(a,b)},each:y,extend:function(a){y(H.call(arguments,1),function(b){for(var c in b)a[c]=b[c]});return a},indexOf:function(a,b,c){if(null==a)return-1;var d;if(c)return c=A(a,b),a[c]===b?c:-1;if(w&&a.indexOf===w)return a.indexOf(b);c=0;for(d=a.length;c<d;c++)if(c in a&&a[c]===b)return c;return-1},sortedIndex:A,identity:z,isNumber:function(a){return"[object Number]"==x.call(a)},isFunction:function(a){return"[object Function]"==x.call(a)||"function"==typeof a},isUndefined:function(a){return void 0===
a},isNull:function(a){return null===a}};var s=function(a,b){this.x=a||0;this.y=b||0};common.extend(s.prototype,{set:function(a,b){this.x=a;this.y=b;return this},copy:function(a){this.x=a.x;this.y=a.y;return this},clear:function(){this.y=this.x=0;return this},clone:function(){return new s(this.x,this.y)},add:function(a,b){this.x=a.x+b.x;this.y=a.y+b.y;return this},addSelf:function(a){this.x+=a.x;this.y+=a.y;return this},sub:function(a,b){this.x=a.x-b.x;this.y=a.y-b.y;return this},subSelf:function(a){this.x-=
a.x;this.y-=a.y;return this},multiplySelf:function(a){this.x*=a.x;this.y*=a.y;return this},multiplyScalar:function(a){this.x*=a;this.y*=a;return this},divideScalar:function(a){a?(this.x/=a,this.y/=a):this.set(0,0);return this},negate:function(){return this.multiplyScalar(-1)},dot:function(a){return this.x*a.x+this.y*a.y},lengthSquared:function(){return this.x*this.x+this.y*this.y},length:function(){return Math.sqrt(this.lengthSquared())},normalize:function(){return this.divideScalar(this.length())},
distanceTo:function(a){return Math.sqrt(this.distanceToSquared(a))},distanceToSquared:function(a){var b=this.x-a.x,a=this.y-a.y;return b*b+a*a},setLength:function(a){return this.normalize().multiplyScalar(a)},equals:function(a){return 1E-4>this.distanceTo(a)},lerp:function(a,b){return this.set((a.x-this.x)*b+this.x,(a.y-this.y)*b+this.y)},isZero:function(){return 1E-4>this.length()}});var l=Vector=s,t=Vector,e=function(a){this.position=new t;this.velocity=new t;this.force=new t;this.mass=a;this.fixed=
!1;this.age=0;this.dead=!1};common.extend(e.prototype,{distanceTo:function(a){return this.position.distanceTo(a.position)},makeFixed:function(){this.fixed=!0;this.velocity.clear();return this},reset:function(){this.age=0;this.dead=!1;this.position.clear();this.velocity.clear();this.force.clear();this.mass=1;return this},resting:function(){return this.fixed||this.velocity.isZero()&&this.force.isZero()}});var B=Particle=e,C=Vector,e=function(a,b,c,d,i){this.constant=c;this.damping=d;this.length=i;this.a=
a;this.b=b;this.on=!0};common.extend(e.prototype,{currentLength:function(){return this.a.position.distanceTo(this.b.position)},update:function(){var a=this.a,b=this.b;if(!this.on||a.fixed&&b.fixed)return this;var c=(new C).sub(a.position,b.position),d=c.length();0===d?c.clear():c.divideScalar(d);var d=-1*(d-this.length)*this.constant,i=(new C).sub(a.velocity,b.velocity),i=-1*this.damping*i.dot(c);c.multiplyScalar(d+i);a.fixed||a.force.addSelf(c);b.fixed||b.force.subSelf(c);return this},resting:function(){var a=
this.a,b=this.b,c=this.length;return!this.on||a.fixed&&b.fixed||a.fixed&&(0===c?b.position.equals(a.position):b.position.distanceTo(a.position)<=c)&&b.resting()||b.fixed&&(0===c?a.position.equals(b.position):a.position.distanceTo(b.position)<=c)&&a.resting()}});var D=Spring=e,I=Vector,e=function(a,b,c,d){this.a=a;this.b=b;this.constant=c;this.on=!0;this.distanceMin=d;this.distanceMinSquared=d*d};common.extend(e.prototype,{update:function(){var a=this.a,b=this.b;if(this.on&&(!a.fixed||!b.fixed)){var c=
(new I).sub(a.position,b.position),d=Math.max(c.lengthSquared(),this.distanceMinSquared),i=this.constant*a.mass*b.mass/d,d=Math.sqrt(d);0===i||0===d?c.clear():c.divideScalar(d).multiplyScalar(i);a.fixed||a.force.subSelf(c);b.fixed||b.force.addSelf(c);return this}},resting:function(){var a=this.a,b=this.b,c=this.distanceMin;return!this.on||a.fixed&&b.fixed||a.fixed&&b.position.distanceTo(a.position)<=c&&b.resting()||b.fixed&&a.position.distanceTo(b.position)<=c&&a.resting()}});var E=Attraction=e,g=
Vector,h=common,e=function(a){this.s=a;this.originalPositions=[];this.originalVelocities=[];this.k1Forces=[];this.k1Velocities=[];this.k2Forces=[];this.k2Velocities=[];this.k3Forces=[];this.k3Velocities=[];this.k4Forces=[];this.k4Velocities=[]};h.extend(e.prototype,{allocateParticles:function(){for(;this.s.particles.length>this.originalPositions.length;)this.originalPositions.push(new g),this.originalVelocities.push(new g),this.k1Forces.push(new g),this.k1Velocities.push(new g),this.k2Forces.push(new g),
this.k2Velocities.push(new g),this.k3Forces.push(new g),this.k3Velocities.push(new g),this.k4Forces.push(new g),this.k4Velocities.push(new g);return this},step:function(a){var b=this.s,c,d;this.allocateParticles();h.each(b.particles,function(a,b){a.fixed||(this.originalPositions[b].copy(a.position),this.originalVelocities[b].copy(a.velocity));a.force.clear()},this);b.applyForces();h.each(b.particles,function(a,b){a.fixed||(this.k1Forces[b].copy(a.force),this.k1Velocities[b].copy(a.velocity));a.force.clear()},
this);h.each(b.particles,function(b,k){if(!b.fixed){var n=this.originalPositions[k],f=this.k1Velocities[k];c=n.x+0.5*f.x*a;d=n.y+0.5*f.y*a;b.position.set(c,d);n=this.originalVelocities[k];f=this.k1Forces[k];c=n.x+0.5*f.x*a/b.mass;d=n.y+0.5*f.y*a/b.mass;b.velocity.set(c,d)}},this);b.applyForces();h.each(b.particles,function(a,b){a.fixed||(this.k2Forces[b].copy(a.force),this.k2Velocities[b].copy(a.velocity));a.force.clear()},this);h.each(b.particles,function(b,c){if(!b.fixed){var d=this.originalPositions[c],
f=this.k2Velocities[c];b.position.set(d.x+0.5*f.x*a,d.y+0.5*f.y*a);d=this.originalVelocities[c];f=this.k2Forces[c];b.velocity.set(d.x+0.5*f.x*a/b.mass,d.y+0.5*f.y*a/b.mass)}},this);b.applyForces();h.each(b.particles,function(a,b){a.fixed||(this.k3Forces[b].copy(a.force),this.k3Velocities[b].copy(a.velocity));a.force.clear()},this);h.each(b.particles,function(b,c){if(!b.fixed){var d=this.originalPositions[c],f=this.k3Velocities[c];b.position.set(d.x+f.x*a,d.y+f.y*a);d=this.originalVelocities[c];f=
this.k3Forces[c];b.velocity.set(d.x+f.x*a/b.mass,d.y+f.y*a/b.mass)}},this);b.applyForces();h.each(b.particles,function(a,b){a.fixed||(this.k4Forces[b].copy(a.force),this.k4Velocities[b].copy(a.velocity))},this);h.each(b.particles,function(b,c){b.age+=a;if(!b.fixed){var d=this.originalPositions[c],f=this.k1Velocities[c],e=this.k2Velocities[c],g=this.k3Velocities[c],h=this.k4Velocities[c],j=d.x+a/6*(f.x+2*e.x+2*g.x+h.x),d=d.y+a/6*(f.y+2*e.y+2*g.y+h.y);b.position.set(j,d);d=this.originalVelocities[c];
f=this.k1Forces[c];e=this.k2Forces[c];g=this.k3Forces[c];h=this.k4Forces[c];j=d.x+a/(6*b.mass)*(f.x+2*e.x+2*g.x+h.x);d=d.y+a/(6*b.mass)*(f.y+2*e.y+2*g.y+h.y);b.velocity.set(j,d)}},this);return this}});var F=Integrator=e,j=common,m=function(){this.__optimized=this.__equilibrium=!1;this.particles=[];this.springs=[];this.attractions=[];this.forces=[];this.integrator=new F(this);this.hasDeadParticles=!1;var a=arguments.length;1===a?(this.gravity=new l(0,arguments[0]),this.drag=m.DEFAULT_DRAG):2===a?(this.gravity=
new l(0,arguments[0]),this.drag=arguments[1]):3===a?(this.gravity=new l(arguments[0],arguments[1]),this.drag=arguments[3]):(this.gravity=new l(0,m.DEFAULT_GRAVITY),this.drag=m.DEFAULT_DRAG)};j.extend(m,{DEFAULT_GRAVITY:0,DEFAULT_DRAG:0.001,Attraction:E,Integrator:F,Particle:B,Spring:D,Vector:l});j.extend(m.prototype,{optimize:function(a){this.__optimized=!!a;return this},setGravity:function(a,b){this.gravity.set(a,b);return this},tick:function(){this.integrator.step(0===arguments.length?1:arguments[0]);
this.__optimized&&(this.__equilibrium=!this.needsUpdate());return this},needsUpdate:function(){for(var a=0,b=this.particles.length;a<b;a++)if(!this.particles[a].resting())return!0;a=0;for(b=this.springs.length;a<b;a++)if(!this.springs[a].resting())return!0;a=0;for(b=this.attractions.length;a<b;a++)if(!this.attractions[a].resting())return!0;return!1},addParticle:function(a){this.particles.push(a);return this},addSpring:function(a){this.springs.push(a);return this},addAttraction:function(a){this.attractions.push(a);
return this},makeParticle:function(a,b,c){a=j.isNumber(a)?a:1;b=b||0;c=c||0;a=new B(a);a.position.set(b,c);this.addParticle(a);return a},makeSpring:function(a,b,c,d,e){a=new D(a,b,c,d,e);this.addSpring(a);return a},makeAttraction:function(a,b,c,d){a=new E(a,b,c,d);this.addAttraction(a);return a},clear:function(){this.particles.length=0;this.springs.length=0;this.attractions.length=0},applyForces:function(){this.gravity.isZero()||j.each(this.particles,function(a){a.force.addSelf(this.gravity)},this);
var a=new l;j.each(this.particles,function(b){a.set(-1*b.velocity.x*this.drag,-1*b.velocity.y*this.drag);b.force.addSelf(a)},this);j.each(this.springs,function(a){a.update()});j.each(this.attractions,function(a){a.update()});j.each(this.forces,function(a){a.update()});return this},clearForces:function(){j.each(this.particles,function(a){a.clear()});return this}});var q=ParticleSystem=m,J=requestAnimationFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||
window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(a){window.setTimeout(a,1E3/60)},p=common,r=function(){var a=this;this.tick();p.each(this.animations,function(a){a()});(this.__optimized&&!this.__equilibrium||!this.__optimized)&&this.playing&&J(function(){r.call(a)})},e=function(){this.playing=!1;q.apply(this,arguments);this.animations=[];r.call(this)};p.extend(e,q,{superclass:q});p.extend(e.prototype,q.prototype,{play:function(){if(this.playing)return this;this.playing=!0;this.__equilibrium=
!1;r.call(this);return this},pause:function(){this.playing=!1;return this},toggle:function(){this.playing?this.pause():this.play();return this},onUpdate:function(a){if(0<=p.indexOf(this.animations,a)||!p.isFunction(a))return this;this.animations.push(a);return this},update:function(){if(!this.__equilibrium)return this;this.__equilibrium=!1;this.playing&&r.call(this);return this}});this.Physics=Physics=e})();